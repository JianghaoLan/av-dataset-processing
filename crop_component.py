"""
convert processed cncvs dataset to wav2lip format.
"""
import json
import os
import argparse
import subprocess
import shutil
import concurrent.futures
from traceback import print_exc
import cv2
import numpy as np

from utils.img_utils import pad_crop
from utils.lms68_utils import get_left_eye, get_mouth, get_right_eye, get_square_roi


def load_json(path):
    with open(path) as f:
        return json.load(f)


def gen_src_data(root, data_list_path):
    with open(data_list_path) as f:
        lines = f.readlines()
    for line in lines:
        line = line.strip()
        data_path = line.split()[0]
        id, vid = data_path.split('/')
        yield id, vid, os.path.join(root, data_path)
        

_get_comp_dict = {
    'mouth': get_mouth,
    'left_eye': get_left_eye,
    'right_eye': get_right_eye
}
def get_component_lms(lms, comp_type: str):
    return _get_comp_dict[comp_type](lms)


def crop_component(src_video_path: str, src_lms_path: str, component: str, dst_dir: str, 
                   lm_img_size: int=512, out_size: int=None, enlarge_ratio: float=1.0, ext: str='.jpg'):
    # # test
    # fourcc = cv2.VideoWriter_fourcc(*'mp4v')  # 可以使用其他编码，如 'MJPG', 'X264' 等
    # out = cv2.VideoWriter('output/crop_component_test.mp4', fourcc, 25.0, (64, 64))
    
    lms = load_json(src_lms_path)
    lms_it = iter(lms)
    
    cap = cv2.VideoCapture(src_video_path)
    if not cap.isOpened():
        print("Error: Unable to open video file.")
        return
    frame_count = 0
    while True:
        ret, frame = cap.read()
        if not ret:
            break

        assert frame.shape[:2] == (lm_img_size, lm_img_size)
        frame_lms = next(lms_it)
        frame_lms = np.asarray(frame_lms, dtype=np.float32)
        comp_lms = get_component_lms(frame_lms, component)
        comp_roi = get_square_roi(comp_lms, enlarge_ratio=enlarge_ratio)
        
        comp_img = pad_crop(frame, comp_roi)
        if out_size is not None and comp_img.shape[:2] != (out_size, out_size):
            comp_img = cv2.resize(comp_img, (out_size, out_size))

        # out.write(cv2.resize(comp_img, (64, 64)))
        output_path = os.path.join(dst_dir, f"{frame_count}{ext}")
        cv2.imwrite(output_path, comp_img)
        frame_count += 1
    # 释放视频对象
    cap.release()
    
    # # test
    # out.release()


def worker(data_path, to_path, component, out_size=None, enlarge_ratio=1.0):
    if os.path.exists(to_path):
        shutil.rmtree(to_path)
    os.makedirs(to_path)
    
    video_path = os.path.join(data_path, 'video.mp4')
    audio_path = os.path.join(data_path, 'audio.wav')
    landmarks_path = os.path.join(data_path, 'aligned_lms.json')
    # rois_path = os.path.join(data_path, 'rois.json')
    
    crop_component(video_path, landmarks_path, component, to_path, 512, out_size=out_size, enlarge_ratio=enlarge_ratio)
    shutil.copyfile(audio_path, os.path.join(to_path, 'audio.wav'))


def process_dataset(dataset_root, output_root, data_list_path, component, max_workers=8, resize=None, enlarge_ratio=1.0):
    src_datas = list(gen_src_data(dataset_root, data_list_path))
    id_num = len(set(map(lambda x: x[0], src_datas)))
    
    print('Total video num:', len(src_datas))
    print('Total id num:', id_num)
    print('From dir:', dataset_root)
    print('To dir:', output_root)
    print('Resize to:', resize)
    print('Processing...')

    with concurrent.futures.ProcessPoolExecutor(max_workers=max_workers) as executor:
        futures = []
        for id, vid, data_path in src_datas:
            dst_dir = os.path.join(output_root, id, vid)

            f = executor.submit(worker, data_path, dst_dir, component, resize, enlarge_ratio)
            # convert_one(data_path, dst_dir, cp_rois_and_lms)
            futures.append(f)
        
        for i, f in enumerate(concurrent.futures.as_completed(futures), 1):
            try:
                f.result()
            except BaseException:
                print_exc()
                executor.shutdown(wait=False)
                exit(0)
            if i % 100 == 0:
                print(f'{i} / {len(src_datas)} completed.')
    print('Finished.')


def main():
    parser = argparse.ArgumentParser()
    parser.add_argument('--dataset_root', type=str, required=True, help='root of processed dataset.')
    parser.add_argument('--output_root', type=str, required=True, help='root of output wav2lip format dataset.')
    parser.add_argument('--data_list_path', type=str, required=True, help='root of result filelist generated by download_and_process.py')
    parser.add_argument('--component', type=str, required=True, help='left_eye, right_eye or mouth')
    parser.add_argument('--max_workers', type=int, help='max num of workers of process pool')
    parser.add_argument('--resize', type=int, default=None, help='resize each image to specific size')
    parser.add_argument('--enlarge_ratio', type=float, default=1.2, help='enlarge ratio.')
    args = parser.parse_args()

    dataset_root = args.dataset_root
    output_root = args.output_root
    data_list_path = args.data_list_path
    component = args.component
    max_workers = args.max_workers
    resize = args.resize
    enlarge_ratio = args.enlarge_ratio

    process_dataset(dataset_root, output_root, data_list_path, component, max_workers=max_workers, resize=resize, enlarge_ratio=enlarge_ratio)
    
    # crop_component('/data2/CN-CVS/synced/s00005/s00005_001_00006/video.mp4', 
    #                '/data2/CN-CVS/synced/s00005/s00005_001_00006/aligned_lms.json', 
    #                'mouth',
    #                None,
    #                512,
    #                None)


if __name__ == '__main__':
    main()
